{"version":3,"sources":["services/OneDriveService.ts"],"names":[],"mappings":"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","file":"services/OneDriveService.js","sourcesContent":["// PnP\r\nimport { sp, RenderListDataOptions } from \"@pnp/sp\";\r\nimport { WebPartContext } from \"@microsoft/sp-webpart-base\";\r\n\r\nimport { SPHttpClient, SPHttpClientResponse, ISPHttpClientOptions } from '@microsoft/sp-http';\r\nimport { IGetListDataAsStreamResult, IRow } from './IOneDriveService';\r\nimport { GeneralHelper } from \"../Utilities\";\r\nimport { FileBrowserService } from \"./FileBrowserService\";\r\nimport { IFile, FilesQueryResult } from \"./FileBrowserService.types\";\r\nimport { ApplicationCustomizerContext } from \"@microsoft/sp-application-base\";\r\n\r\nexport class OneDriveService extends FileBrowserService {\r\n  protected oneDrivePersonalUrl: string;\r\n  protected oneDriveRootFolderRelativeUrl: string;\r\n  protected oneDriveRootFolderAbsoluteUrl: string;\r\n  protected oneDrivePersonalLibraryTitle: string;\r\n\r\n  constructor(context: ApplicationCustomizerContext | WebPartContext, itemsToDownloadCount?: number) {\r\n    super(context, itemsToDownloadCount);\r\n\r\n    this.oneDrivePersonalUrl = null;\r\n    this.oneDriveRootFolderRelativeUrl = null;\r\n    this.oneDriveRootFolderAbsoluteUrl = null;\r\n    this.oneDrivePersonalLibraryTitle = null;\r\n  }\r\n\r\n  /**\r\n   * Gets files from OneDrive personal library\r\n   */\r\n  public getListItems = async (libraryName: string, folderPath?: string, acceptedFilesExtensions?: string[], nextPageQueryStringParams?: string): Promise<FilesQueryResult> => {\r\n    let filesQueryResult: FilesQueryResult = { items: [], nextHref: null };\r\n    try {\r\n      const oneDriveRootFolder = await this.getOneDriveRootFolderFullUrl();\r\n      const encodedListUrl = encodeURIComponent(oneDriveRootFolder);\r\n\r\n      let queryStringParams = \"\";\r\n      folderPath = folderPath ? folderPath : this.oneDriveRootFolderRelativeUrl;\r\n      const encodedFolderPath = encodeURIComponent(folderPath);\r\n\r\n      if (nextPageQueryStringParams) {\r\n        // Remove start ? from the query params\r\n        if (nextPageQueryStringParams.charAt(0) === \"?\") {\r\n          nextPageQueryStringParams = nextPageQueryStringParams.substring(1);\r\n        }\r\n        queryStringParams = nextPageQueryStringParams;\r\n      } else {\r\n        queryStringParams = `RootFolder=${encodedFolderPath}`;\r\n      }\r\n\r\n      const restApi = `${this.context.pageContext.web.absoluteUrl}/_api/SP.List.GetListDataAsStream?listFullUrl='${encodedListUrl}'&${queryStringParams}`;\r\n      filesQueryResult = await this._getListDataAsStream(restApi, null, acceptedFilesExtensions);\r\n    } catch (error) {\r\n      filesQueryResult.items = null;\r\n      console.error(error.message);\r\n    }\r\n    return filesQueryResult;\r\n  }\r\n\r\n  /**\r\n   * Downloads document content from OneDrive location.\r\n   */\r\n  public downloadSPFileContent = async (absoluteFileUrl: string, fileName: string): Promise<File> => {\r\n    try {\r\n      const fileDownloadResult = await this.context.spHttpClient.get(absoluteFileUrl, SPHttpClient.configurations.v1, {\r\n        method: \"GET\",\r\n        mode: \"cors\"\r\n      });\r\n\r\n      if (!fileDownloadResult || !fileDownloadResult.ok) {\r\n        throw new Error(`Something went wrong when downloading the file. Status='${fileDownloadResult.status}'`);\r\n      }\r\n\r\n      // Return file created from blob\r\n      const blob : Blob = await fileDownloadResult.blob();\r\n      return  new File([blob], fileName);\r\n    } catch (err) {\r\n      console.error(`[OneDriveService.fetchFileContent] Err='${err.message}'`);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n     * Gets users one drive personal documents library path\r\n     */\r\n  public getOneDriveRootFolderFullUrl = async (): Promise<string> => {\r\n    try {\r\n      // Return result if already obtained\r\n      if (this.oneDriveRootFolderAbsoluteUrl) {\r\n        return this.oneDriveRootFolderAbsoluteUrl;\r\n      }\r\n\r\n      const oneDriveUrl = await this.getOneDrivePersonalUrl();\r\n      if (!oneDriveUrl) {\r\n        throw new Error(`Cannot obtain OneDrive personal URL.`);\r\n      }\r\n      const apiUrl: string = `${this.context.pageContext.web.absoluteUrl}/_api/SP.RemoteWeb(@a1)/Web/Lists?$filter=BaseTemplate eq 700 and BaseType eq 1&@a1='${encodeURIComponent(oneDriveUrl)}'`;\r\n      const oneDriveFolderResult = await this.context.spHttpClient.get(apiUrl, SPHttpClient.configurations.v1, {\r\n        headers: {\r\n          \"accept\": \"application/json;odata=nometadata\",\r\n          \"content-type\": \"application/json;odata=nometadata\",\r\n          \"odata-version\": \"\"\r\n        }\r\n      });\r\n      if (!oneDriveFolderResult || !oneDriveFolderResult.ok) {\r\n        throw new Error(`Something went wrong when executing oneDriveRootFolder retrieve request. Status='${oneDriveFolderResult.status}'`);\r\n      }\r\n\r\n      const oneDriveLibsData = await oneDriveFolderResult.json();\r\n      if (!oneDriveLibsData || !oneDriveLibsData.value || oneDriveLibsData.value.length == 0) {\r\n        throw new Error(`Cannot read one drive libs data.`);\r\n      }\r\n\r\n      const myDocumentsLibrary = oneDriveLibsData.value[0];\r\n      this.oneDrivePersonalLibraryTitle = myDocumentsLibrary.Title;\r\n      this.oneDriveRootFolderRelativeUrl = `${myDocumentsLibrary.ParentWebUrl}/${myDocumentsLibrary.Title}`;\r\n      this.oneDriveRootFolderAbsoluteUrl = `${this.oneDrivePersonalUrl}${myDocumentsLibrary.Title}`;\r\n    } catch (error) {\r\n      console.error(`[FileBrowserService.getOneDrivePersonalUrl] Err='${error.message}'`);\r\n      this.oneDriveRootFolderAbsoluteUrl = null;\r\n    }\r\n    return this.oneDriveRootFolderAbsoluteUrl;\r\n  }\r\n\r\n  /**\r\n   * Gets OneDrive RootFolder server relative URL.\r\n   */\r\n  public getOneDriveRootFolderRelativeUrl = async (): Promise<string> => {\r\n    if (!this.oneDriveRootFolderRelativeUrl) {\r\n      await this.getOneDriveRootFolderFullUrl();\r\n    }\r\n    return this.oneDriveRootFolderRelativeUrl;\r\n  }\r\n\r\n  /**\r\n   * Gets OneDrive personal library Title\r\n   */\r\n  public getOneDrivePersonalLibraryTitle = async (): Promise<string> => {\r\n    if (!this.oneDrivePersonalLibraryTitle) {\r\n      await this.getOneDriveRootFolderFullUrl();\r\n    }\r\n    return this.oneDrivePersonalLibraryTitle;\r\n  }\r\n\r\n  /**\r\n   * Gets personal site path.\r\n   */\r\n  private getOneDrivePersonalUrl = async (): Promise<string> => {\r\n    try {\r\n      // Return result if already obtained\r\n      if (this.oneDrivePersonalUrl) {\r\n        return this.oneDrivePersonalUrl;\r\n      }\r\n\r\n      const userProfileApi = `${this.context.pageContext.web.absoluteUrl}/_api/SP.UserProfiles.ProfileLoader.GetProfileLoader/GetUserProfile`;\r\n      const userProfileResult = await this.context.spHttpClient.post(userProfileApi, SPHttpClient.configurations.v1, {});\r\n\r\n      if (!userProfileResult || !userProfileResult.ok) {\r\n        throw new Error(`Something went wrong when executing user profile request. Status='${userProfileResult.status}'`);\r\n      }\r\n\r\n      const profileData = await userProfileResult.json();\r\n      if (!profileData) {\r\n        throw new Error(`Cannot read user profile data.`);\r\n      }\r\n\r\n      this.oneDrivePersonalUrl = profileData.FollowPersonalSiteUrl;\r\n    } catch (error) {\r\n      console.error(`[FileBrowserService.getOneDrivePersonalUrl] Err='${error.message}'`);\r\n      this.oneDrivePersonalUrl = null;\r\n    }\r\n    return this.oneDrivePersonalUrl;\r\n  }\r\n\r\n  /**\r\n   * Creates an absolute URL\r\n   */\r\n  protected buildAbsoluteUrl = (relativeUrl: string) => {\r\n    const oneDriveHost = `https://${this.oneDrivePersonalUrl.split(\"//\")[1].split(\"/\")[0]}`;\r\n    return oneDriveHost + relativeUrl;\r\n  }\r\n}\r\n"],"sourceRoot":"..\\..\\src"}